<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>3D Particle Christmas Tree ğŸ„</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #050505; font-family: 'Arial', sans-serif; }
        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        /* æ‘„åƒå¤´é¢„è§ˆ (è°ƒè¯•ç”¨ï¼Œå®é™…å¯éšè—) */
        #video-input { position: absolute; top: 10px; left: 10px; width: 160px; height: 120px; z-index: 2; border-radius: 8px; opacity: 0.7; transform: scaleX(-1); }
        
        /* äº¤äº’æç¤ºUI */
        #ui-layer { position: absolute; bottom: 20px; width: 100%; text-align: center; color: gold; z-index: 3; pointer-events: none; text-shadow: 0 0 10px red; }
        .gesture-icon { font-size: 24px; margin: 0 10px; opacity: 0.6; }
        .active-gesture { opacity: 1; transform: scale(1.5); transition: 0.3s; }

        /* ä¿¡çº¸å¼¹çª— */
        #letter-overlay {
            display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 80%; max-width: 400px; background: url('https://www.transparenttextures.com/patterns/aged-paper.png'), #fff1c1;
            padding: 30px; border-radius: 5px; box-shadow: 0 0 50px rgba(255, 215, 0, 0.5); z-index: 10;
            text-align: center; color: #5a3e36; font-family: 'Brush Script MT', cursive;
        }
        #letter-content { font-size: 1.5em; border: none; background: transparent; width: 100%; resize: none; outline: none; text-align: center; }
        .close-btn { margin-top: 15px; cursor: pointer; border: 1px solid #5a3e36; padding: 5px 15px; border-radius: 20px; }

        /* ç…§ç‰‡å±•ç¤ºåŒº (ç®€åŒ–ç‰ˆ) */
        #photo-overlay { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9; }
        #photo-img { max-width: 80vw; max-height: 80vh; border: 5px solid gold; box-shadow: 0 0 30px red; border-radius: 10px; }
    </style>
</head>
<body>

    <div id="canvas-container"></div>
    <video id="video-input" playsinline></video>

    <div id="ui-layer">
        <span id="g-fist" class="gesture-icon">âœŠ èšåˆ</span>
        <span id="g-open" class="gesture-icon">âœ‹ æ•£å¼€</span>
        <span id="g-point" class="gesture-icon">â˜ï¸ ä¿¡çº¸</span>
        <span id="g-vict" class="gesture-icon">âœŒï¸ ç¥ç¦</span>
        <span id="g-ok" class="gesture-icon">ğŸ‘Œ ç…§ç‰‡</span>
    </div>

    <div id="letter-overlay">
        <h2>To My Best Friend</h2>
        <textarea id="letter-content" rows="4">Merry Christmas! 
æ„¿ä½ çš„ç”Ÿæ´»åƒè¿™æ£µæ ‘ä¸€æ ·é—ªé—ªå‘å…‰ï¼</textarea>
        <div class="close-btn" onclick="toggleLetter(false)">Close</div>
    </div>

    <div id="photo-overlay">
        <img id="photo-img" src="" alt="Christmas Memory">
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <script>
    /**
     * ============================================================
     * ğŸ… è‡ªå®šä¹‰é…ç½®åŒº (USER CONFIGURATION)
     * åœ¨è¿™é‡Œä¿®æ”¹é¢œè‰²ã€éŸ³ä¹ã€å›¾ç‰‡å’Œæ–‡å­—
     * ============================================================
     */
    const CONFIG = {
        particleCount: 15000,
        colors: {
            gold: 0xFFD700,
            red: 0xFF0000,
            green: 0x006400,
            firework: [0xFF0000, 0x00FF00, 0x0000FF, 0xFFFF00, 0xFF00FF]
        },
        musicUrl: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3', // æ›¿æ¢ä¸ºä½ çš„mp3é“¾æ¥
        photoUrls: [
            'https://picsum.photos/400/400?random=1', // æ›¿æ¢ç…§ç‰‡é“¾æ¥1
            'https://picsum.photos/400/400?random=2'  // æ›¿æ¢ç…§ç‰‡é“¾æ¥2
        ],
        textMessage: "MERRY\nCHRISTMAS" // ç²’å­ç»„æˆçš„æ–‡å­—
    };

    /**
     * ============================================================
     * ğŸ„ æ ¸å¿ƒé€»è¾‘åŒº
     * ============================================================
     */
    let scene, camera, renderer, particles, geometry;
    let originalPositions = [], treePositions = [], spherePositions = [], textPositions = [];
    let currentShape = 'tree'; 
    let mouseX = 0;
    
    // åˆå§‹åŒ– Three.js ç¯å¢ƒ
    function initThree() {
        scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x050505, 0.002);

        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 2000);
        camera.position.z = 1000;

        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // åˆ›å»ºç²’å­ç³»ç»Ÿ
        createParticles();
        
        // æ·»åŠ ç¯å¢ƒå…‰
        const light = new THREE.PointLight(0xffffff, 1);
        light.position.set(0, 500, 500);
        scene.add(light);

        // éŸ³ä¹
        const audioListener = new THREE.AudioListener();
        camera.add(audioListener);
        // æ³¨æ„ï¼šæµè§ˆå™¨é€šå¸¸éœ€è¦ç”¨æˆ·äº¤äº’(ç‚¹å‡»)æ‰èƒ½æ’­æ”¾å£°éŸ³
        window.addEventListener('click', () => {
            // è¿™é‡Œå¯ä»¥æ·»åŠ éŸ³é¢‘æ’­æ”¾é€»è¾‘
        });

        animate();
    }

    // åˆ›å»ºç²’å­æ•°æ®
    function createParticles() {
        geometry = new THREE.BufferGeometry();
        const positions = [];
        const colors = [];
        const colorObj = new THREE.Color();

        for (let i = 0; i < CONFIG.particleCount; i++) {
            // 1. åˆå§‹ä½ç½® (éšæœº)
            const x = Math.random() * 2000 - 1000;
            const y = Math.random() * 2000 - 1000;
            const z = Math.random() * 2000 - 1000;
            positions.push(x, y, z);
            originalPositions.push(x, y, z);

            // 2. é¢œè‰²åˆ†é… (é‡‘çº¢ä¸ºä¸»ï¼Œç»¿ä¸ºè¾…)
            const rand = Math.random();
            if (rand > 0.6) colorObj.setHex(CONFIG.colors.gold);
            else if (rand > 0.3) colorObj.setHex(CONFIG.colors.red);
            else colorObj.setHex(CONFIG.colors.green);
            colors.push(colorObj.r, colorObj.g, colorObj.b);

            // 3. è®¡ç®—å½¢æ€ç›®æ ‡ä½ç½®
            
            // A. åœ£è¯æ ‘å½¢æ€ (èºæ—‹åœ†é”¥)
            const angle = i * 0.1;
            const radius = i * 0.05; // åº•éƒ¨å˜å®½
            const treeY = i * 0.1 - 500;
            const treeX = Math.cos(angle) * radius * 4;
            const treeZ = Math.sin(angle) * radius * 4;
            treePositions.push(treeX, treeY, treeZ);

            // B. åœ†å½¢äº‘ç‚¹ (çƒä½“)
            const phi = Math.acos(-1 + (2 * i) / CONFIG.particleCount);
            const theta = Math.sqrt(CONFIG.particleCount * Math.PI) * phi;
            const sphereR = 600;
            spherePositions.push(
                sphereR * Math.cos(theta) * Math.sin(phi),
                sphereR * Math.sin(theta) * Math.sin(phi),
                sphereR * Math.cos(phi)
            );

            // C. æ–‡å­—å½¢æ€ (ç®€åŒ–ç‰ˆï¼šå¹³é¢æ’åˆ—)
            // å®é™…æ–‡å­—ç”Ÿæˆéœ€è¦Canvasæ‰«æåƒç´ ï¼Œè¿™é‡Œç®€åŒ–ä¸ºæ’åˆ—æˆçŸ©å½¢é˜µåˆ—æ¨¡æ‹Ÿ"å¢™"
            textPositions.push((i % 100) * 10 - 500, Math.floor(i / 100) * 10 - 300, 0);
        }

        geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
        geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));

        const material = new THREE.PointsMaterial({ 
            size: 6, 
            vertexColors: true,
            blending: THREE.AdditiveBlending,
            depthTest: false,
            transparent: true
        });

        particles = new THREE.Points(geometry, material);
        scene.add(particles);
    }

    // å˜æ¢å½¢æ€
    function transformTo(shapeType) {
        if(currentShape === shapeType) return;
        currentShape = shapeType;
        
        let target = [];
        if (shapeType === 'tree') target = treePositions;
        else if (shapeType === 'sphere') target = spherePositions;
        else if (shapeType === 'text') target = textPositions;

        // ä½¿ç”¨ GSAP åŠ¨ç”»è¿‡æ¸¡ç²’å­ä½ç½®
        const positions = particles.geometry.attributes.position.array;
        
        // è¿™æ˜¯ä¸€ä¸ªç®€åŒ–çš„åŠ¨ç”»ï¼Œå®é™…åº”ç”¨ä¸­å¯èƒ½éœ€è¦æ›´å¤æ‚çš„Shaderæˆ–é€ç‚¹Tween
        // ä¸ºäº†æ€§èƒ½ï¼Œæˆ‘ä»¬è¿™é‡Œæ¨¡æ‹Ÿ"é£å‘"ç›®æ ‡
        gsap.to(particles.rotation, { duration: 1, y: particles.rotation.y + Math.PI });
        
        // ç®€å•çš„é€ç‚¹æ’å€¼æ¼”ç¤º (æ³¨æ„ï¼šå¤§é‡ç²’å­é€ä¸ªTweenä¼šå¡é¡¿ï¼Œè¿™é‡Œä»…åšçŠ¶æ€æ ‡è®°ï¼Œ
        // å®é™…æ¸²æŸ“å¾ªç¯ä¸­å»ºè®®ä½¿ç”¨çº¿æ€§æ’å€¼ lerp)
        const dummyObj = { val: 0 };
        const startPos = Float32Array.from(positions); // æ‹·è´å½“å‰ä½ç½®
        
        gsap.to(dummyObj, {
            val: 1,
            duration: 2,
            ease: "power2.inOut",
            onUpdate: () => {
                for(let i=0; i < CONFIG.particleCount; i++) {
                    const idx = i * 3;
                    positions[idx] = startPos[idx] + (target[idx] - startPos[idx]) * dummyObj.val;
                    positions[idx+1] = startPos[idx+1] + (target[idx+1] - startPos[idx+1]) * dummyObj.val;
                    positions[idx+2] = startPos[idx+2] + (target[idx+2] - startPos[idx+2]) * dummyObj.val;
                }
                particles.geometry.attributes.position.needsUpdate = true;
            },
            onComplete: () => {
                 if(shapeType === 'text') launchFireworks();
            }
        });
    }

    // çƒŸèŠ±æ•ˆæœ (ç®€å•å®ç°)
    function launchFireworks() {
        // åˆ›å»ºä¸´æ—¶ç²’å­çˆ†ç‚¸æ•ˆæœ
        // å®é™…ä»£ç éœ€å¢åŠ ä¸“é—¨çš„çƒŸèŠ±ç±»
        console.log("Boom! Fireworks!");
        document.body.style.backgroundColor = "#200";
        setTimeout(() => document.body.style.backgroundColor = "#050505", 200);
    }

    function animate() {
        requestAnimationFrame(animate);
        
        // æ—‹è½¬é€»è¾‘
        if (currentShape === 'tree') {
            particles.rotation.y += 0.002;
        } else if (currentShape === 'sphere') {
            // æ‰‹åŠ¿æ§åˆ¶æ—‹è½¬
            particles.rotation.y += mouseX * 0.01;
        }

        renderer.render(scene, camera);
    }

    /**
     * ============================================================
     * âœ‹ æ‰‹åŠ¿è¯†åˆ«é€»è¾‘ (MediaPipe)
     * ============================================================
     */
    const videoElement = document.getElementById('video-input');
    
    function onResults(results) {
        if (!results.multiHandLandmarks || results.multiHandLandmarks.length === 0) return;

        const landmarks = results.multiHandLandmarks[0];
        detectGesture(landmarks);
    }

    // ç®€å•çš„æ‰‹åŠ¿åˆ¤æ–­ç®—æ³•
    function detectGesture(landmarks) {
        // è·å–æŒ‡å°–å’ŒæŒ‡æ ¹åæ ‡
        const thumbTip = landmarks[4];
        const indexTip = landmarks[8];
        const middleTip = landmarks[12];
        const ringTip = landmarks[16];
        const pinkyTip = landmarks[20];
        const wrist = landmarks[0];

        // 1. åˆ¤æ–­æ‰‹æŒ‡æ˜¯å¦ä¼¸ç›´ (yåæ ‡æ¯”å…³èŠ‚é«˜)
        const isIndexOpen = indexTip.y < landmarks[6].y;
        const isMiddleOpen = middleTip.y < landmarks[10].y;
        const isRingOpen = ringTip.y < landmarks[14].y;
        const isPinkyOpen = pinkyTip.y < landmarks[18].y;
        const isThumbOpen = thumbTip.x < landmarks[2].x; // ç®€åŒ–åˆ¤æ–­

        let gesture = "";

        // âœŠ Fist: æ‰€æœ‰æ‰‹æŒ‡å·æ›²
        if (!isIndexOpen && !isMiddleOpen && !isRingOpen && !isPinkyOpen) {
            gesture = "FIST";
            highlightIcon('g-fist');
            transformTo('tree');
            toggleLetter(false);
            togglePhoto(false);
        }
        // âœ‹ Open Hand: æ‰€æœ‰æ‰‹æŒ‡ä¼¸å¼€
        else if (isIndexOpen && isMiddleOpen && isRingOpen && isPinkyOpen) {
            gesture = "OPEN";
            highlightIcon('g-open');
            transformTo('sphere');
            // è®¡ç®—æ‰‹æŒä¸­å¿ƒXåæ ‡ç”¨äºæ—‹è½¬
            mouseX = (landmarks[9].x - 0.5) * 2; 
        }
        // âœŒï¸ Victory: é£ŸæŒ‡ä¸­æŒ‡ä¼¸å¼€
        else if (isIndexOpen && isMiddleOpen && !isRingOpen && !isPinkyOpen) {
            gesture = "VICTORY";
            highlightIcon('g-vict');
            transformTo('text');
        }
        // â˜ï¸ Point: åªæœ‰é£ŸæŒ‡
        else if (isIndexOpen && !isMiddleOpen && !isRingOpen && !isPinkyOpen) {
            gesture = "POINT";
            highlightIcon('g-point');
            toggleLetter(true);
        }
        // ğŸ‘Œ OK: æ‹‡æŒ‡é£ŸæŒ‡ç›¸è§¦ (è·ç¦»å¾ˆè¿‘)
        else {
            const distance = Math.hypot(thumbTip.x - indexTip.x, thumbTip.y - indexTip.y);
            if (distance < 0.05 && isMiddleOpen) {
                gesture = "OK";
                highlightIcon('g-ok');
                if(currentShape === 'sphere') togglePhoto(true);
            }
        }
    }

    function highlightIcon(id) {
        document.querySelectorAll('.gesture-icon').forEach(el => el.classList.remove('active-gesture'));
        document.getElementById(id).classList.add('active-gesture');
    }

    // UI äº¤äº’
    function toggleLetter(show) {
        document.getElementById('letter-overlay').style.display = show ? 'block' : 'none';
    }

    let photoIndex = 0;
    function togglePhoto(show) {
        const el = document.getElementById('photo-overlay');
        if (show && el.style.display !== 'block') {
            // åˆ‡æ¢ä¸‹ä¸€å¼ 
            photoIndex = (photoIndex + 1) % CONFIG.photoUrls.length;
            document.getElementById('photo-img').src = CONFIG.photoUrls[photoIndex];
            el.style.display = 'block';
        } else if (!show) {
            el.style.display = 'none';
        }
    }

    // å¯åŠ¨ MediaPipe
    const hands = new Hands({locateFile: (file) => {
        return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
    }});
    hands.setOptions({
        maxNumHands: 1,
        modelComplexity: 1,
        minDetectionConfidence: 0.7,
        minTrackingConfidence: 0.7
    });
    hands.onResults(onResults);

    const cameraUtils = new Camera(videoElement, {
        onFrame: async () => {
            await hands.send({image: videoElement});
        },
        width: 320,
        height: 240
    });
    
    // åˆå§‹åŒ–
    initThree();
    cameraUtils.start();

    // çª—å£è‡ªé€‚åº”
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

    </script>
</body>
</html>